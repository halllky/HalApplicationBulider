using OpenQA.Selenium;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Nijo.IntegrationTest.Tests {
    partial class 観点 {
        [Test]
        public async Task 最小限のバックグラウンドタスクをWebから起動して正常終了するまでを確認() {

            // 自動生成されるソースの作成
            TestProject.UpdateAutoGeneratedCode(
                DataPattern.FromFileName(DataPattern.FILENAME_014));

            // 自動生成されないソース（ジョブ処理内容）の作成
            // TODO

            // ---------------------------------------
            using var launcher = TestProject.Current.CreateLauncher();
            var errors = new StringBuilder();
            launcher.OnError += (s, e) => errors.AppendLine(e);
            launcher.Launch();
            launcher.WaitForReady();

            using var driver = TestProject.CreateWebDriver();
            await driver.InitializeData();

            // 取り込み用CSVの準備
            File.WriteAllText("test014.csv", $$"""
                "従業員コード", "雇用形態"
                "A-0111", "アルバイト"
                "A-0222", "正社員"
                "A-0333", "正社員"
                """);

            // 更新対象のデータの従業員コードを上記CSVのものと合わせる（1人目）
            driver.FindElement(Util.ByInnerText("従業員")).Click();
            await Util.WaitUntil(() => driver.FindElements(Util.ByInnerText("詳細")).Count > 0);
            driver.FindElements(Util.ByInnerText("詳細"))[0].Click();
            driver.FindElement(By.Name("従業員コード")).SendKeys("A-0111");
            driver.FindElement(Util.ByInnerText("一時保存")).Click();

            // 更新対象のデータの従業員コードを上記CSVのものと合わせる（2人目）
            driver.FindElement(Util.ByInnerText("従業員")).Click();
            await Util.WaitUntil(() => driver.FindElements(Util.ByInnerText("詳細")).Count > 0);
            driver.FindElements(Util.ByInnerText("詳細"))[1].Click();
            driver.FindElement(By.Name("従業員コード")).SendKeys("A-0222");
            driver.FindElement(Util.ByInnerText("一時保存")).Click();

            // ジョブ起動
            var uploadFile = Path.Combine(Directory.GetCurrentDirectory(), "test014.csv");
            driver.FindElement(Util.ByInnerText("従業員データ一括取り込み")).Click();
            driver.FindElement(By.Name("取込ファイル")).SendKeys(uploadFile);
            driver.FindElement(Util.ByInnerText("全部更新")).Click();
            driver.FindElement(Util.ByInnerText("実行")).Click();

            // 完了を待機
            driver.Navigate().GoToUrl("/");
            await Util.WaitUntil(() => driver.FindElements(Util.ByInnerText("完了")).Count > 0);
            Assert.That(driver.FindElements(Util.ByInnerText("完了")).Count, Is.AtLeast(1));
        }
    }
}
