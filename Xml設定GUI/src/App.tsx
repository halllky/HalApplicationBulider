import React from 'react'
import useEvent from 'react-use-event-hook'
import { useFieldArray, useWatch } from 'react-hook-form'
import * as Util from './__autoGenerated/util'
import * as Input from './__autoGenerated/input'
import * as Layout from './__autoGenerated/collection'
import { PageState } from './types'
import { useBackend } from './useBackend'
import { useColumnDef } from './useColumnDef'

function App() {

  const { registerEx, reset, control } = Util.useFormEx<PageState>({})
  const { ready, load, backendDomain, onChangBackendDomain } = useBackend()
  const aggregateOrMemberTypes = useWatch({ name: 'aggregateOrMemberTypes', control })
  const optionalAttributes = useWatch({ name: 'optionalAttributes', control })
  const columns = useColumnDef(aggregateOrMemberTypes, optionalAttributes)
  const { fields } = useFieldArray({ name: 'aggregates', control })

  const reload = useEvent(async () => {
    const initialState = await load()
    reset(initialState)
  })

  React.useEffect(() => {
    if (ready) reload()
  }, [ready])

  return (
    <div className="flex flex-col w-full h-full p-1 gap-1" style={style}>
      <div className="flex gap-1 items-center">
        <label className="flex-1 flex gap-1 items-center">
          バックエンドURL
          <Input.Word value={backendDomain} onChange={onChangBackendDomain} className="flex-1" />
        </label>
        <Input.IconButton onClick={reload}>再読み込み</Input.IconButton>
      </div>
      <div className="flex gap-1 items-center">
        <label className="flex-1 flex gap-1 items-center">
          ファイル名
          <Input.Word {...registerEx('editingXmlFilePath')} className="flex-1" />
        </label>
      </div>
      <Layout.DataTable
        data={fields}
        columns={columns}
        className="flex-1"
      />
    </div>
  )
}

const style: React.CSSProperties = {
  fontFamily: '"Cascadia Mono", "BIZ UDGothic"',
}

export default App
