using HalApplicationBuilder.Core;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace HalApplicationBuilder.Features {
    internal class ApplicationService {
        internal ApplicationService(Config config) {
            _config = config;
        }

        private readonly Config _config;

        internal string ClassName => $"AutoGeneratedApplicationService";
        internal string FileName => $"{ClassName}.cs";

        internal string ConcreteClass => $"OverridedApplicationService";
        internal string ConcreteClassFileName => $"{ConcreteClass}.cs";

        internal string ServiceProvider = "ServiceProvider";
        internal string DbContext = "DbContext";
        internal string CurrentTime = "CurrentTime";

        internal SourceFile Render() => new SourceFile {
            FileName = FileName,
            RenderContent = ctx => $$"""
                namespace {{ctx.Config.RootNamespace}} {
                    using {{ctx.Config.DbContextNamespace}};

                    public partial class {{ClassName}} {
                        public {{ClassName}}(IServiceProvider serviceProvider) {
                            {{ServiceProvider}} = serviceProvider;
                        }

                        protected IServiceProvider {{ServiceProvider}} { get; }

                        private {{ctx.Config.DbContextName}}? _dbContext;
                        protected virtual {{ctx.Config.DbContextName}} {{DbContext}} => _dbContext ??= {{ServiceProvider}}.GetRequiredService<{{ctx.Config.DbContextName}}>();

                        private DateTime? _currentTime;
                        protected virtual DateTime {{CurrentTime}} => _currentTime ??= DateTime.Now;
                    }
                }
                """,
        };
    }
}
