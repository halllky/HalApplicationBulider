using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using System.Reflection;

namespace HalApplicationBuilder.Core {
    public abstract class AggregateMemberBase {

        internal ApplicationSchema Schema { get; init; }
        internal PropertyInfo UnderlyingPropertyInfo { get; init; }

        public string Name => UnderlyingPropertyInfo.Name;
        public bool IsPrimaryKey => UnderlyingPropertyInfo.GetCustomAttribute<KeyAttribute>() != null;
        /// <summary>
        /// Entity Framework エンティティ作成時に連番カラムを生成するか否かに影響
        /// </summary>
        public abstract bool IsCollection { get; }


        #region リレーション
        public Aggregate Owner { get; init; }
        public abstract IEnumerable<Aggregate> GetChildAggregates();
        #endregion リレーション


        #region CodeGenerating
        internal abstract IEnumerable<AutoGenerateDbEntityProperty> ToDbColumnModel();

        private IEnumerable<UIProperty> _searchConditionClass;
        private IEnumerable<UIProperty> _searchResultClass;
        private IEnumerable<UIProperty> _instanceClass;

        internal IEnumerable<UIProperty> ToSearchConditionModel() {
            if (_searchConditionClass == null) {
                _searchConditionClass = CreateSearchConditionModel().ToArray();
                foreach (var x in _searchConditionClass) x.Source = this;
            }
            return _searchConditionClass;
        }
        internal IEnumerable<UIProperty> ToSearchResultModel() {
            if (_searchResultClass == null) {
                _searchResultClass = CreateSearchResultModel().ToArray();
                foreach (var x in _searchResultClass) x.Source = this;
            }
            return _searchResultClass;
        }
        internal IEnumerable<UIProperty> ToInstanceModel() {
            if (_instanceClass == null) {
                _instanceClass = CreateInstanceModel().ToArray();
                foreach (var x in _instanceClass) x.Source = this;
            }
            return _instanceClass;
        }

        protected abstract IEnumerable<UIProperty> CreateSearchConditionModel();
        protected abstract IEnumerable<UIProperty> CreateSearchResultModel();
        protected abstract IEnumerable<UIProperty> CreateInstanceModel();

        internal abstract string RenderSearchConditionView(ViewRenderingContext context);
        internal abstract string RenderSearchResultView(ViewRenderingContext context);
        internal abstract string RenderInstanceView(ViewRenderingContext context);
        #endregion CodeGenerating


        #region Runtime

        #endregion Runtime
    }
}
