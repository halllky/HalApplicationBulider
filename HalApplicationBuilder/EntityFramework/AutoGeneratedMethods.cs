using System;
using System.Collections.Generic;
using System.Linq;
using HalApplicationBuilder.Core;
using HalApplicationBuilder.Core.DBModel;

namespace HalApplicationBuilder.EntityFramework {
    public class AutoGeneratedMethods {

        public string TransformText(IApplicationSchema applicationSchema, IDbSchema dbSchema, Config config) {

            var loadAutoCompleteData = applicationSchema
                .RootAggregates()
                .Select(aggreate => dbSchema.GetDbEntity(aggreate))
                .Select(dbEntity => new LoadAutoComplele(dbEntity, config));

            var template = new AutoGeneratedMethodsTemplate {
                DbContextNamespace = config.DbContextNamespace,
                DbContextName = config.DbContextName,
                LoadAutoCompleteMethod = loadAutoCompleteData,
            };
            return template.TransformText();
        }


        public class LoadAutoComplele {
            public LoadAutoComplele(DbEntity dbEntity, Config config) {
                _dbEntity = dbEntity;
                _config = config;
            }
            private readonly DbEntity _dbEntity;
            private readonly Config _config;

            public string DbSetName => _dbEntity.DbSetName;
            public string EntityClassName => $"{_config.EntityNamespace}.{_dbEntity.ClassName}";
            public string MethodName => $"LoadAutoCompleteSource_{_dbEntity.ClassName}";
            public string NameColumnName => null; // TODO
        }
    }

    partial class AutoGeneratedMethodsTemplate {
        public object DbContextNamespace { get; set; }
        public object DbContextName { get; set; }
        public IEnumerable<AutoGeneratedMethods.LoadAutoComplele> LoadAutoCompleteMethod { get; set; }
    }
}
