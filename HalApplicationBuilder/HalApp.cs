using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using HalApplicationBuilder.Core.DBModel;
using HalApplicationBuilder.Core.UIModel;
using Microsoft.Extensions.DependencyInjection;

namespace HalApplicationBuilder {
    public sealed class HalApp : Core.IApplicationSchema, IDbSchema, IViewModelProvider {

        public static void Configure(IServiceCollection serviceCollection, Assembly assembly) {
            serviceCollection.AddScoped(_ => new Core.Config {
                DbContextName = "SampleDbContext",
                DbContextNamespace = "HalApplicationBuilderSampleMvc.EntityFramework",
                EntityNamespace = "HalApplicationBuilderSampleMvc.EntityFramework.Entities",
                MvcModelNamespace = "HalApplicationBuilderSampleMvc.Models",
                MvcControllerNamespace = "HalApplicationBuilderSampleMvc.Controllers",
                MvcViewDirectoryRelativePath = "Views/__AutoGenerated",
            });
            serviceCollection.AddScoped(provider => new HalApp(assembly, provider));
            serviceCollection.AddScoped<Core.IAggregateMemberFactory>(provider => new Core.Members.AggregateMemberFactory(provider));
            serviceCollection.AddScoped<Core.IApplicationSchema>(provider => provider.GetRequiredService<HalApp>());
            serviceCollection.AddScoped<Core.UIModel.IViewModelProvider>(provider => provider.GetRequiredService<HalApp>());
            serviceCollection.AddScoped<Core.DBModel.IDbSchema>(provider => provider.GetRequiredService<HalApp>());
        }

        private HalApp(Assembly assembly, IServiceProvider serviceProvider) {
            _schemaAssembly = assembly;
            _services = serviceProvider;
        }

        private readonly Assembly _schemaAssembly;
        private readonly IServiceProvider _services;


        /// <summary>
        /// コードの自動生成を実行します。
        /// </summary>
        public void GenerateCode(TextWriter stream = null) {

            var validator = new Core.AggregateValidator(_services);
            if (validator.HasError(error => stream?.WriteLine(error))) {
                stream?.WriteLine("コード自動生成終了");
                return;
            }

            stream?.WriteLine($"コード自動生成開始");

            var efSourceDir = "/__local__/20221211_haldoc_csharp/haldoc/HalApplicationBuilderSampleMvc/EntityFramework/__AutoGenerated";
            if (!Directory.Exists(efSourceDir)) Directory.CreateDirectory(efSourceDir);

            stream?.WriteLine("コード自動生成: Entity定義");
            using (var sw = new StreamWriter(Path.Combine(efSourceDir, "Entities.cs"), append: false, encoding: Encoding.UTF8)) {
                sw.Write(EntityFramework.EntityClassRenderer.Render(
                    _services.GetRequiredService<Core.IApplicationSchema>(),
                    _services.GetRequiredService<Core.DBModel.IDbSchema>(),
                    _services.GetRequiredService<Core.Config>()));
            }
            stream?.WriteLine("コード自動生成: DbSet");
            using (var sw = new StreamWriter(Path.Combine(efSourceDir, "DbSet.cs"), append: false, encoding: Encoding.UTF8)) {
                sw.Write(EntityFramework.DbSetRenderer.Render(
                    _services.GetRequiredService<Core.IApplicationSchema>(),
                    _services.GetRequiredService<Core.DBModel.IDbSchema>(),
                    _services.GetRequiredService<Core.Config>()));
            }
            stream?.WriteLine("コード自動生成: OnModelCreating");
            using (var sw = new StreamWriter(Path.Combine(efSourceDir, "OnModelCreating.cs"), append: false, encoding: Encoding.UTF8)) {
                sw.Write(EntityFramework.OnModelCreatingRenderer.Render(
                    _services.GetRequiredService<Core.IApplicationSchema>(),
                    _services.GetRequiredService<Core.DBModel.IDbSchema>(),
                    _services.GetRequiredService<Core.Config>()));
            }
            stream?.WriteLine("コード自動生成: Search");
            using (var sw = new StreamWriter(Path.Combine(efSourceDir, "Search.cs"), append: false, encoding: Encoding.UTF8)) {
                sw.Write(EntityFramework.SearchMethodRenderer.Render(
                    _services.GetRequiredService<Core.IApplicationSchema>(),
                    _services.GetRequiredService<Core.DBModel.IDbSchema>(),
                    _services.GetRequiredService<Core.UIModel.IViewModelProvider>(),
                    _services.GetRequiredService<Core.Config>()));
            }
            stream?.WriteLine("コード自動生成: AutoCompleteSource");
            using (var sw = new StreamWriter(Path.Combine(efSourceDir, "AutoCompleteSource.cs"), append: false, encoding: Encoding.UTF8)) {
                sw.Write(EntityFramework.AutoCompleteSourceMethodRenderer.Render(
                    _services.GetRequiredService<Core.IApplicationSchema>(),
                    _services.GetRequiredService<Core.DBModel.IDbSchema>(),
                    _services.GetRequiredService<Core.UIModel.IViewModelProvider>(),
                    _services.GetRequiredService<Core.Config>()));
            }

            stream?.WriteLine("コード自動生成: MVC Model");
            var modelDir = "/__local__/20221211_haldoc_csharp/haldoc/HalApplicationBuilderSampleMvc/Models";
            var modelFile = Path.Combine(modelDir, "__AutoGeneratedModels.cs");
            if (!Directory.Exists(modelDir)) Directory.CreateDirectory(modelDir);
            using (var sw = new StreamWriter(modelFile, append: false, encoding: Encoding.UTF8)) {
                var source = new AspNetMvc.MvcModels();
                sw.Write(source.TransformText(
                    _services.GetRequiredService<Core.IApplicationSchema>(),
                    _services.GetRequiredService<Core.UIModel.IViewModelProvider>(),
                    _services.GetRequiredService<Core.Config>()));
            }

            //stream?.WriteLine("コード自動生成: MVC View - 既存ファイル削除");
            var viewDir = Path.Combine(
                "/__local__/20221211_haldoc_csharp/haldoc/HalApplicationBuilderSampleMvc",
                _services.GetRequiredService<Core.Config>().MvcViewDirectoryRelativePath);
            if (!Directory.Exists(viewDir)) Directory.CreateDirectory(viewDir);
            //foreach (var file in Directory.GetFiles(viewDir)) {
            //    File.Delete(file);
            //}

            stream?.WriteLine("コード自動生成: MVC View - MultiView");
            foreach (var aggregate in _services.GetRequiredService<Core.IApplicationSchema>().RootAggregates()) {
                var view = new AspNetMvc.MultiView(aggregate);
                var filename = Path.Combine(viewDir, view.FileName);
                using var sw = new StreamWriter(filename, append: false, encoding: Encoding.UTF8);
                sw.Write(view.TransformText(_services.GetRequiredService<Core.UIModel.IViewModelProvider>()));
            }

            stream?.WriteLine("コード自動生成: MVC View - SingleView");
            foreach (var aggregate in _services.GetRequiredService<Core.IApplicationSchema>().RootAggregates()) {
                var view = new AspNetMvc.SingleView(aggregate);
                var filename = Path.Combine(viewDir, view.FileName);
                using var sw = new StreamWriter(filename, append: false, encoding: Encoding.UTF8);
                sw.Write(view.TransformText(
                    _services.GetRequiredService<Core.UIModel.IViewModelProvider>(),
                    _services.GetRequiredService<Core.Config>()));
            }

            stream?.WriteLine("コード自動生成: MVC View - CreateView");
            foreach (var aggregate in _services.GetRequiredService<Core.IApplicationSchema>().RootAggregates()) {
                var view = new AspNetMvc.CreateView(aggregate);
                var filename = Path.Combine(viewDir, view.FileName);
                using var sw = new StreamWriter(filename, append: false, encoding: Encoding.UTF8);
                sw.Write(view.TransformText(
                    _services.GetRequiredService<Core.UIModel.IViewModelProvider>(),
                    _services.GetRequiredService<Core.Config>()));
            }

            stream?.WriteLine("コード自動生成: MVC View - 集約部分ビュー");
            foreach (var aggregate in _services.GetRequiredService<Core.IApplicationSchema>().AllAggregates()) {
                var view = new AspNetMvc.InstancePartialView(
                    aggregate,
                    _services.GetRequiredService<Core.Config>());
                var filename = Path.Combine(viewDir, view.FileName);
                using var sw = new StreamWriter(filename, append: false, encoding: Encoding.UTF8);
                sw.Write(view.TransformText(
                    _services.GetRequiredService<Core.UIModel.IViewModelProvider>()));
            }

            stream?.WriteLine("コード自動生成: MVC Controller");
            var controllerDir = "/__local__/20221211_haldoc_csharp/haldoc/HalApplicationBuilderSampleMvc/Controllers";
            var controllerFile = Path.Combine(controllerDir, "__AutoGeneratedControllers.cs");
            if (!Directory.Exists(controllerDir)) Directory.CreateDirectory(controllerDir);
            using (var sw = new StreamWriter(controllerFile, append: false, encoding: Encoding.UTF8)) {
                var source = new AspNetMvc.Controller();
                sw.Write(source.TransformText(
                    _services.GetRequiredService<Core.IApplicationSchema>(),
                    _services.GetRequiredService<Core.UIModel.IViewModelProvider>(),
                    _services.GetRequiredService<Core.Config>()));
            }

            stream?.WriteLine("コード自動生成: JS");
            {
                var view = new AspNetMvc.JsTemplate();
                var filename = Path.Combine(viewDir, AspNetMvc.JsTemplate.FILE_NAME);
                using var sw = new StreamWriter(filename, append: false, encoding: Encoding.UTF8);
                sw.Write(view.TransformText());
            }

            stream?.WriteLine("コード自動生成終了");
        }


        /// <summary>
        /// 実行時コンテキストを取得します。
        /// </summary>
        public Core.Runtime.RuntimeContext GetRuntimeContext(Assembly runtimeAssembly) {
            return new Core.Runtime.RuntimeContext(_schemaAssembly, runtimeAssembly, _services);
        }


        #region ApplicationSchema
        private HashSet<Core.Aggregate> _appSchema;
        private Dictionary<string, Core.Aggregate> _pathMapping;
        private IReadOnlySet<Core.Aggregate> AppSchema {
            get {
                if (_appSchema == null) BuildAggregates();
                return _appSchema;
            }
        }
        private IReadOnlyDictionary<string, Core.Aggregate> PathMapping {
            get {
                if (_pathMapping == null) BuildAggregates();
                return _pathMapping;
            }
        }
        private void BuildAggregates() {
            var memberFactory = _services.GetRequiredService<Core.IAggregateMemberFactory>();
            var rootAggregates = _schemaAssembly
                .GetTypes()
                .Where(type => type.GetCustomAttribute<AggregateAttribute>() != null)
                .Select(type => new Core.Aggregate(type, null, memberFactory));

            _appSchema = new HashSet<Core.Aggregate>();
            foreach (var aggregate in rootAggregates) {
                _appSchema.Add(aggregate);

                foreach (var descendant in aggregate.GetDescendants()) {
                    _appSchema.Add(descendant);
                }
            }

            _pathMapping = _appSchema
                .GroupBy(aggregate => new Core.AggregatePath(aggregate))
                .ToDictionary(path => path.Key.Value, path => path.First());
        }

        public IEnumerable<Core.Aggregate> AllAggregates() {
            return AppSchema;
        }
        public IEnumerable<Core.Aggregate> RootAggregates() {
            return AppSchema.Where(a => a.Parent == null);
        }
        public Core.Aggregate FindByType(Type type) {
            return AppSchema.SingleOrDefault(a => a.UnderlyingType == type);
        }
        public Core.Aggregate FindByPath(string aggregatePath) {
            return PathMapping[aggregatePath];
        }
        #endregion ApplicationSchema


        #region DbSchema
        private Dictionary<Core.Aggregate, DbEntity> _dbEntities;
        private IReadOnlyDictionary<Core.Aggregate, DbEntity> DbEntities {
            get {
                if (_dbEntities == null) {
                    var config = _services.GetRequiredService<Core.Config>();
                    var aggregates = AllAggregates()
                        .OrderBy(a => a.GetAncestors().Count())
                        .ToList();
                    _dbEntities = new Dictionary<Core.Aggregate, DbEntity>();
                    foreach (var aggregate in aggregates) {
                        var parent = aggregate.Parent == null
                            ? null
                            : _dbEntities[aggregate.Parent.Owner];
                        var child = new DbEntity(aggregate, parent, config);
                        _dbEntities.Add(aggregate, child);
                        parent?.children.Add(child);
                    }
                }
                return _dbEntities;
            }
        }

        public DbEntity GetDbEntity(Core.Aggregate aggregate) {
            return DbEntities[aggregate];
        }
        #endregion DbSchema


        #region ViewModelProvider
        private Dictionary<Core.Aggregate, SearchConditionClass> _searchConditions;
        private Dictionary<Core.Aggregate, SearchResultClass> _searchResults;
        private Dictionary<Core.Aggregate, MvcModel> _instanceModels;

        private IReadOnlyDictionary<Core.Aggregate, SearchConditionClass> SearchConditions {
            get {
                if (_searchConditions == null) {

                    var config = _services.GetRequiredService<Core.Config>();
                    var aggregates = AllAggregates()
                        .OrderBy(a => a.GetAncestors().Count())
                        .ToList();

                    _searchConditions = new Dictionary<Core.Aggregate, SearchConditionClass>();
                    foreach (var aggregate in aggregates) {
                        _searchConditions.Add(aggregate, new SearchConditionClass {
                            Source = aggregate,
                            Config = config,
                        });
                    }
                }
                return _searchConditions;
            }
        }
        private IReadOnlyDictionary<Core.Aggregate, SearchResultClass> SearchResults {
            get {
                if (_searchResults == null) {

                    var config = _services.GetRequiredService<Core.Config>();
                    var aggregates = AllAggregates()
                        .OrderBy(a => a.GetAncestors().Count())
                        .ToList();

                    _searchResults = new Dictionary<Core.Aggregate, SearchResultClass>();
                    foreach (var aggregate in aggregates) {
                        _searchResults.Add(aggregate, new SearchResultClass {
                            Source = aggregate,
                            Config = config,
                        });
                    }
                }
                return _searchResults;
            }
        }
        private IReadOnlyDictionary<Core.Aggregate, MvcModel> InstanceModels {
            get {
                if (_instanceModels == null) {

                    var config = _services.GetRequiredService<Core.Config>();
                    var aggregates = AllAggregates()
                        .OrderBy(a => a.GetAncestors().Count())
                        .ToList();

                    _instanceModels = new Dictionary<Core.Aggregate, MvcModel>();
                    foreach (var aggregate in aggregates) {
                        _instanceModels.Add(aggregate, new InstanceModelClass {
                            Source = aggregate,
                            Config = config,
                        });
                    }
                }
                return _instanceModels;
            }
        }

        public MvcModel GetInstanceModel(Core.Aggregate aggregate) {
            return InstanceModels[aggregate];
        }
        public SearchConditionClass GetSearchConditionModel(Core.Aggregate aggregate) {
            return SearchConditions[aggregate];
        }
        public SearchResultClass GetSearchResultModel(Core.Aggregate aggregate) {
            return SearchResults[aggregate];
        }
        #endregion ViewModelProvider
    }
}
