using Nijo.Core;
using Nijo.Parts.WebClient;
using Nijo.Parts.WebServer;
using Nijo.Util.CodeGenerating;
using Nijo.Util.DotnetEx;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading.Tasks;

namespace Nijo.Parts {
    /// <summary>
    /// 自動生成されるクラスライブラリに対する操作を提供します。
    /// このクラスライブラリはWebとCLIの両方から参照されます。
    /// </summary>
    public class CoreLibrary {

        public CoreLibrary(GeneratedProject generatedProject) {
            _generatedProject = generatedProject;
        }

        private readonly GeneratedProject _generatedProject;

        public string ProjectRoot => Path.Combine(_generatedProject.SolutionRoot, "core");
        public string AutoGeneratedDir => Path.Combine(ProjectRoot, "__AutoGenerated");

        /// <summary>
        /// プロジェクトディレクトリを新規作成します。
        /// </summary>
        public void CreateProjectIfNotExists(Core.Config config) {
            if (Directory.Exists(ProjectRoot)) return;

            // 埋め込みリソースからテンプレートを出力
            var resources = new EmbeddedResource.Collection(Assembly.GetExecutingAssembly());
            foreach (var resource in resources.Enumerate("core")) {
                var destination = Path.Combine(
                    ProjectRoot,
                    Path.GetRelativePath("core", resource.RelativePath));

                Directory.CreateDirectory(Path.GetDirectoryName(destination)!);

                using var reader = resource.GetStreamReader();
                using var writer = SourceFile.GetStreamWriter(destination);
                while (!reader.EndOfStream) {
                    writer.WriteLine(reader.ReadLine());
                }
            }

            // ファイル名変更
            var beforeCsproj = Path.Combine(ProjectRoot, "NIJO_APPLICATION_TEMPLATE.csproj");
            var afterCsproj = Path.Combine(ProjectRoot, $"{config.ApplicationName}.csproj");
            File.Move(beforeCsproj, afterCsproj);

            // オーバーライド用のアプリケーションサービス具象クラスのファイルを作成
            var overridedAppSrv = new WebServer.ApplicationService();
            var overrideAppSrv = Path.Combine(ProjectRoot, overridedAppSrv.ConcreteClassFileName);
            File.WriteAllText(overrideAppSrv, overridedAppSrv
                .RenderConcreteClass(config)
                /// TODO: <see cref="DirectorySetupper.Generate(SourceFile)"/> を使用していないのでわざわざ置換する必要がある
                .Replace(SKIP_MARKER, string.Empty));
        }

        /// <summary>
        /// コード自動生成処理のソースをわかりやすくするためのクラス
        /// </summary>
        public class DirectoryEditor {
            internal DirectoryEditor(CodeRenderingContext context, CoreLibrary project) {
                _context = context;
                _project = project;
                _autoGeneratedDir = DirectorySetupper.StartSetup(_context, _project.AutoGeneratedDir);
            }
            private readonly CodeRenderingContext _context;
            private readonly CoreLibrary _project;
            private readonly DirectorySetupper _autoGeneratedDir;

            /// <summary>
            /// 自動生成ディレクトリ直下へのソース生成を行います。
            /// </summary>
            public void AutoGeneratedDir(Action<DirectorySetupper> setup) {
                setup(_autoGeneratedDir);
            }

            /// <summary>
            /// ユーティリティに関するクラスを格納するディレクトリへのソース生成を行います。
            /// </summary>
            public void UtilDir(Action<DirectorySetupper> setup) {
                _autoGeneratedDir.Directory("Util", setup);
            }

            public void UseAggregateFile(GraphNode<Aggregate> aggregate, Action<AggregateFile> fn) {
                if (!_itemsByAggregate.TryGetValue(aggregate, out var item)) {
                    item = new AggregateFile(aggregate);
                    _itemsByAggregate.Add(aggregate, item);
                }
                fn(item);
            }
            internal readonly Dictionary<GraphNode<Aggregate>, AggregateFile> _itemsByAggregate = new();

            public List<string> AppSrvMethods { get; } = new List<string>();

            public List<Func<string, string>> ConfigureServices { get; } = new List<Func<string, string>>();

            public List<Func<string, string>> DbContextOnModelCreating { get; } = new List<Func<string, string>>();
        }
    }
}
