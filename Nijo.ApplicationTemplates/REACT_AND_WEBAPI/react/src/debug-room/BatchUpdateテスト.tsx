import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
import { useFieldArray } from 'react-hook-form'
import { PanelGroup, Panel, PanelResizeHandle } from 'react-resizable-panels'
import * as Collection from '../__autoGenerated/collection'
import * as Input from '../__autoGenerated/input'
import * as Util from '../__autoGenerated/util'

import "../__autoGenerated/nijo-default-style.css"


export default function () {
  return (
    <Util.LocalRepositoryContextProvider>
      <Util.MsgContextProvider>
        <Page />
      </Util.MsgContextProvider>
    </Util.LocalRepositoryContextProvider>
  )
}

const Page = () => {

  // ローカルリポジトリ（サイドメニュー）
  const { changes, reset: resetLocalRepos, commit } = Util.useLocalRepositoryChangeList()

  // リモートリポジトリ ※デバッグ用インメモリ
  const { arrRemoteRepos, inmemoryRemoteRepos, setInmemoryRemoteRepos } = useInMemoryRemoteRepository()

  // ローカルリポジトリ
  type GridRow = Util.LocalRepositoryItem<TestData>
  const { control, reset: resetForm } = Util.useFormEx<{ items: GridRow[] }>({})
  const { fields, append, update, remove } = useFieldArray({ name: 'items', control })
  const reposSetting: Util.LocalRepositoryArgs<TestData> = useMemo(() => ({
    dataTypeKey: 'TEST-DATA-20240204',
    getItemKey: data => data.key ?? '',
    getItemName: data => data.name ?? '',
    loadRemoteItems: () => Promise.resolve(arrRemoteRepos),
  }), [arrRemoteRepos])

  const {
    ready,
    items: localAndRemoteItems,
    add: addToLocalRepository,
    update: updateLocalRepositoryItem,
    remove: deleteLocalRepositoryItem,
  } = Util.useLocalRepository(reposSetting)

  const handleAdd: React.MouseEventHandler<HTMLButtonElement> = useCallback(async () => {
    append(await addToLocalRepository({ name: '新規データ' }))
  }, [append, addToLocalRepository])

  const handleUpdateRow = useCallback(async (index: number, row: GridRow) => {
    update(index, await updateLocalRepositoryItem(row.itemKey, row.item))
  }, [update, updateLocalRepositoryItem])

  const dtRef = useRef<Collection.DataTableRef<GridRow>>(null)
  const handleRemove: React.MouseEventHandler<HTMLButtonElement> = useCallback(async () => {
    if (!dtRef.current) return
    const deletedRowIndex: number[] = []
    for (const { row, rowIndex } of dtRef.current.getSelectedRows()) {
      const deleted = await deleteLocalRepositoryItem(row.itemKey, row.item)
      if (deleted) update(rowIndex, deleted)
      else deletedRowIndex.push(rowIndex)
    }
    remove(deletedRowIndex)
  }, [update, remove, deleteLocalRepositoryItem])

  const handleCreateDummy = useCallback(async () => {
    for (const item of createDefaultData().items) {
      append(await addToLocalRepository(item))
    }
  }, [append, addToLocalRepository])

  const [, dispatchMsg] = Util.useMsgContext()
  const handleCommit = useCallback(async () => {
    const remote = new Map(inmemoryRemoteRepos)
    const success = await commit(async (item: Util.LocalRepositoryStoredItem<TestData>) => {
      if (!item.item.key) {
        return { commit: false }

      } else if (item.state === '+') {
        if (remote.has(item.item.key)) {
          dispatchMsg(msg => msg.error(`キー重複: ${item.item.key}`))
          return { commit: false }
        }
        remote.set(item.item.key, item.item)
        return { commit: true }

      } else if (item.state === '*') {
        if (!remote.has(item.item.key)) {
          dispatchMsg(msg => msg.error(`更新対象なし: ${item.item.key}`))
          return { commit: false }
        }
        remote.set(item.item.key, item.item)
        return { commit: true }

      } else if (item.state === '-') {
        if (!remote.has(item.item.key)) {
          dispatchMsg(msg => msg.error(`削除対象なし: ${item.item.key}`))
          return { commit: false }
        }
        remote.delete(item.item.key)
        return { commit: true }

      } else {
        return { commit: false }
      }
    })
    setInmemoryRemoteRepos(remote)
    dispatchMsg(msg => success
      ? msg.info('保存しました。')
      : msg.info('エラーがあります。'))
  }, [commit, inmemoryRemoteRepos, setInmemoryRemoteRepos, dispatchMsg])

  const handleReset = useCallback(async () => {
    await resetLocalRepos()
    resetForm({ items: localAndRemoteItems })
  }, [resetLocalRepos, localAndRemoteItems, resetForm])

  useEffect(() => {
    if (ready) resetForm({ items: localAndRemoteItems })
  }, [ready, localAndRemoteItems, resetForm])

  return (
    <PanelGroup
      direction="horizontal"
      className="w-full h-full p-2"
      style={{ fontFamily: '"Arial", "BIZ UDゴシック"', fontSize: 14 }}
    >
      <Panel defaultSize={21} className="flex flex-col">
        <div className="flex gap-2 justify-start">
          <Input.Button onClick={handleCommit}>コミット</Input.Button>
          <Input.Button onClick={handleReset}>リセット</Input.Button>
          <div className="flex-1"></div>
        </div>
        <Collection.DataTable
          data={changes}
          columns={LIST_COLS}
          className="flex-1"
        />
      </Panel>

      <PanelResizeHandle className="w-4" />

      <Panel>
        <PanelGroup direction="vertical">
          <Panel className="flex flex-col">
            <div className="flex gap-2 justify-start">
              <span className="font-bold">LOCAL</span>
              <Input.Button onClick={handleAdd}>追加</Input.Button>
              <Input.Button onClick={handleRemove}>削除</Input.Button>
              <Input.Button onClick={handleCreateDummy}>ダミー</Input.Button>
              <div className="flex-1"></div>
            </div>
            <Collection.DataTable
              ref={dtRef}
              data={fields}
              columns={LOCAL_REPOS_COLS}
              onChangeRow={handleUpdateRow}
              className="flex-1"
            />
          </Panel>

          <PanelResizeHandle className="h-2" />

          <Panel className="flex flex-col">
            <span className="font-bold">REMOTE</span>
            <Collection.DataTable
              data={arrRemoteRepos}
              columns={REMOTE_REPOS_COLS}
              className="flex-1"
            />
          </Panel>
        </PanelGroup>
        <Util.InlineMessageList />
        <Util.Toast />
      </Panel>
    </PanelGroup>
  )
}

type TestDataCollection = {
  items: TestData[]
}
type TestData = {
  key?: string
  name?: string
  numValue?: number
}

const LIST_COLS: Collection.ColumnDefEx<Util.TreeNode<Util.LocalRepositoryItemListItem>>[] = [
  { id: 'col0', header: '　', accessorFn: x => x.item.state, size: 12 },
  { id: 'col1', header: '　', accessorFn: x => x.item.itemName },
]
const LOCAL_REPOS_COLS: Collection.ColumnDefEx<Util.TreeNode<Util.LocalRepositoryItem<TestData>>>[] = [
  { id: 'state', header: '', accessorFn: x => x.item.state, size: 12 },
  { id: 'key', header: 'key', accessorFn: x => x.item.item.key, setValue: (x, v) => x.item.item.key = v, cellEditor: (props, ref) => <Input.Word ref={ref} {...props} /> },
  { id: 'name', header: '名前', accessorFn: x => x.item.item.name, setValue: (x, v) => x.item.item.name = v, cellEditor: (props, ref) => <Input.Word ref={ref} {...props} />, },
  { id: 'numValue', header: '数値', accessorFn: x => x.item.item.numValue, setValue: (x, v) => x.item.item.numValue = v, cellEditor: (props, ref) => <Input.Num ref={ref} {...props} /> },
]
const REMOTE_REPOS_COLS: Collection.ColumnDefEx<Util.TreeNode<TestData>>[] = [
  { id: 'key', header: 'key', accessorFn: x => x.item.key },
  { id: 'name', header: '名前', accessorFn: x => x.item.name },
  { id: 'numValue', header: '数値', accessorFn: x => x.item.numValue },
]


function createDefaultData(): TestDataCollection {
  const items: TestData[] = [
    { key: '001', name: 'データ01', numValue: 1.00 },
    { key: '002', name: 'データ02', numValue: 2.00 },
    { key: '003', name: 'データ03', numValue: 3.00 },
    { key: '004', name: 'データ04', numValue: 4.00 },
  ]
  return { items }
}


const useInMemoryRemoteRepository = () => {
  const [inmemoryRemoteRepos, setInmemoryRemoteRepos] = useState<Map<string, TestData>>(() => new Map())
  const arrRemoteRepos = useMemo(() => {
    return Array.from(inmemoryRemoteRepos.values())
  }, [inmemoryRemoteRepos])

  return {
    arrRemoteRepos,
    inmemoryRemoteRepos,
    setInmemoryRemoteRepos,
  }
}
