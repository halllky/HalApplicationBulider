using HalApplicationBuilder.DotnetEx;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace HalApplicationBuilder.IntegrationTest.Perspectives {
    public class _デバッグ用ビルド {
        [UseDataPatterns]
        public async Task デバッグ用ビルド(DataPattern pattern) {
            try {
                File.WriteAllText(SharedResource.Project.GetAggregateSchemaPath(), pattern.LoadXmlString());
                SharedResource.Project.CodeGenerator.UpdateAutoGeneratedCode();
                using var ct = new CancellationTokenSource();
                await Task.WhenAll(
                    Task.Run(SharedResource.Project.Migrator.DeleteAndRecreateDatabase),
                    SharedResource.Project.Debugger.BuildAsync(ct.Token));
            } catch {
                TestContext.Out.WriteLine("--- SCHEMA ---");
                TestContext.Out.WriteLine(SharedResource.Project.BuildSchema().Graph.ToMermaidText());
                throw;
            }
        }

        [Test]
        [Ignore("動作確認が完了したため")]
        public async Task npm_startの終了後にプロセスが残り続けないか() {
            using var ct = new CancellationTokenSource();
            var terminal = new Terminal(SharedResource.Project.WebClientProjectRoot, new TestContextLogger());
            Task npmProcess;
            try {
                npmProcess = await terminal.RunBackground(
                    new[] { "npm", "run", "dev" },
                    new Regex("➜"),
                    ct.Token);

                await Task.Delay(1000, ct.Token);

            } finally {
                ct.Cancel();
            }

            await npmProcess;
        }
    }
}
